#!/usr/bin/env python3 """ Decomposer Service for Vietnamese Fact Checker Phân tách claim phức tạp thành các sub-claims đơn giản """ import asyncio import json import time from typing import Dict, List, Optional from fastapi import FastAPI, HTTPException from pydantic import BaseModel import uvicorn import requests class DecomposeRequest(BaseModel): claim: str language: str = "vietnamese" max_sub_claims: int = 5 class SubClaim(BaseModel): text: str confidence: float entities: List[str] complexity_score: float class DecomposeResponse(BaseModel): original_claim: str sub_claims: List[SubClaim] entities: List[str] complexity_score: float processing_time: float success: bool error: Optional[str] = None class DecomposerService: def __init__(self, llm_url: str = "http://localhost:8009"): self.llm_url = llm_url self.decomposition_prompt = """ Phân tích claim tiếng Việt thành các atomic claims (claims đơn giản nhất có thể kiểm chứng độc lập). QUY TẮT VÀNG: Mỗi claim phải là CÂU ĐỦ NGHĨA Mỗi claim chỉ chứa MỘT thông tin chính Có thể kiểm chứng độc lập KHÔNG tách tên riêng, chức danh, tổ chức KHÔNG tạo claim < 4 từ EXAMPLES: Example 1 - Geography: Claim: "Hà Nội là thủ đô của Việt Nam và có dân số hơn 8 triệu người" {{ "sub_claims": [ {{ "text": "Hà Nội là thủ đô của Việt Nam", "confidence": 0.95, "entities": ["Hà Nội", "Việt Nam", "thủ đô"], "complexity_score": 0.2 }}, {{ "text": "Hà Nội có dân số hơn 8 triệu người", "confidence": 0.85, "entities": ["Hà Nội", "dân số", "8 triệu người"], "complexity_score": 0.3 }} ], "entities": ["Hà Nội", "Việt Nam", "thủ đô", "dân số", "8 triệu người"], "complexity_score": 0.4 }} Example 2 - Culture: Claim: "Phở là món ăn truyền thống của Việt Nam và được UNESCO công nhận là di sản văn hóa thế giới" {{ "sub_claims": [ {{ "text": "Phở là món ăn truyền thống của Việt Nam", "confidence": 0.92, "entities": ["Phở", "Việt Nam", "món ăn truyền thống"], "complexity_score": 0.3 }}, {{ "text": "Phở được UNESCO công nhận là di sản văn hóa thế giới", "confidence": 0.75, "entities": ["Phở", "UNESCO", "di sản văn hóa thế giới"], "complexity_score": 0.4 }} ], "entities": ["Phở", "Việt Nam", "món ăn truyền thống", "UNESCO", "di sản văn hóa thế giới"], "complexity_score": 0.5 }} Example 3 - Technology: Claim: "Viettel là nhà mạng viễn thông lớn nhất Việt Nam và đang triển khai công nghệ 5G trên toàn quốc" {{ "sub_claims": [ {{ "text": "Viettel là nhà mạng viễn thông lớn nhất Việt Nam", "confidence": 0.85, "entities": ["Viettel", "nhà mạng viễn thông", "Việt Nam", "lớn nhất"], "complexity_score": 0.4 }}, {{ "text": "Viettel đang triển khai công nghệ 5G trên toàn quốc", "confidence": 0.80, "entities": ["Viettel", "công nghệ 5G", "toàn quốc"], "complexity_score": 0.3 }} ], "entities": ["Viettel", "nhà mạng viễn thông", "Việt Nam", "lớn nhất", "công nghệ 5G", "toàn quốc"], "complexity_score": 0.6 }} Example 4 - Environment: Claim: "Việt Nam cam kết giảm phát thải khí nhà kính 30% vào năm 2030 và phát triển năng lượng tái tạo" {{ "sub_claims": [ {{ "text": "Việt Nam cam kết giảm phát thải khí nhà kính 30% vào năm 2030", "confidence": 0.90, "entities": ["Việt Nam", "phát thải khí nhà kính", "30%", "năm 2030"], "complexity_score": 0.3 }}, {{ "text": "Việt Nam phát triển năng lượng tái tạo", "confidence": 0.85, "entities": ["Việt Nam", "năng lượng tái tạo"], "complexity_score": 0.2 }} ], "entities": ["Việt Nam", "phát thải khí nhà kính", "30%", "năm 2030", "năng lượng tái tạo"], "complexity_score": 0.4 }} Example 5 - Health: Claim: "Bệnh COVID-19 đã được kiểm soát tốt ở Việt Nam với tỷ lệ tiêm chủng đạt 95% dân số" {{ "sub_claims": [ {{ "text": "Bệnh COVID-19 đã được kiểm soát tốt ở Việt Nam", "confidence": 0.80, "entities": ["Bệnh COVID-19", "Việt Nam", "kiểm soát"], "complexity_score": 0.3 }}, {{ "text": "Tỷ lệ tiêm chủng COVID-19 đạt 95% dân số Việt Nam", "confidence": 0.85, "entities": ["tiêm chủng", "95%", "dân số", "Việt Nam"], "complexity_score": 0.2 }} ], "entities": ["Bệnh COVID-19", "Việt Nam", "kiểm soát", "tiêm chủng", "95%", "dân số"], "complexity_score": 0.4 }} Bây giờ hãy phân tích claim sau theo đúng format: Claim: "{claim}" Chỉ trả về JSON, không thêm text khác. """ async def check_llm_health(self) -> bool: """Check if LLM service is available""" try: response = requests.get(f"{self.llm_url}/health", timeout=5) return response.status_code == 200 except: return False async def call_llm(self, prompt: str) -> str: """Call LLM service""" try: payload = { "prompt": prompt, "temperature": 0.1, "max_tokens": 1000 } response = requests.post( f"{self.llm_url}/generate", json=payload, timeout=60 ) if response.status_code == 200: data = response.json() return data.get("response", "") else: return "" except Exception as e: print(f"LLM call error: {e}") return "" async def parse_llm_response(self, response: str) -> Dict: """Parse LLM response to extract JSON""" try: # Try to find JSON in response import re json_match = re.search(r'\{.*\}', response, re.DOTALL) if json_match: json_str = json_match.group() return json.loads(json_str) else: # Fallback: try to parse entire response return json.loads(response) except Exception as e: print(f"JSON parsing error: {e}") return { "sub_claims": [], "entities": [], "complexity_score": 0.0 } async def decompose_claim(self, claim: str, language: str = "vietnamese", max_sub_claims: int = 5) -> DecomposeResponse: """Decompose complex claim into sub-claims""" start_time = time.time() try: # Check LLM service health if not await self.check_llm_health(): return DecomposeResponse( original_claim=claim, sub_claims=[], entities=[], complexity_score=0.0, processing_time=time.time() - start_time, success=False, error="LLM service not available" ) # Prepare prompt prompt = self.decomposition_prompt.format( claim=claim, max_claims=max_sub_claims ) # Call LLM llm_response = await self.call_llm(prompt) if not llm_response: return DecomposeResponse( original_claim=claim, sub_claims=[], entities=[], complexity_score=0.0, processing_time=time.time() - start_time, success=False, error="Empty LLM response" ) # Parse response parsed_data = await self.parse_llm_response(llm_response) # Create sub-claims sub_claims = [] for sub_data in parsed_data.get("sub_claims", []): sub_claim = SubClaim( text=sub_data.get("text", ""), confidence=sub_data.get("confidence", 0.0), entities=sub_data.get("entities", []), complexity_score=sub_data.get("complexity_score", 0.0) ) sub_claims.append(sub_claim) processing_time = time.time() - start_time return DecomposeResponse( original_claim=claim, sub_claims=sub_claims, entities=parsed_data.get("entities", []), complexity_score=parsed_data.get("complexity_score", 0.0), processing_time=processing_time, success=True ) except Exception as e: processing_time = time.time() - start_time return DecomposeResponse( original_claim=claim, sub_claims=[], entities=[], complexity_score=0.0, processing_time=processing_time, success=False, error=str(e) ) # FastAPI App app = FastAPI(title="Decomposer Service", description="Claim Decomposition Service") # Global service instance decomposer_service = DecomposerService() @app.get("/") async def root(): """Health check endpoint""" llm_healthy = await decomposer_service.check_llm_health() return { "status": "healthy", "llm_service": "connected" if llm_healthy else "disconnected", "service": "Decomposer Service", "port": 8006 } @app.get("/health") async def health(): """Detailed health check""" llm_healthy = await decomposer_service.check_llm_health() return { "status": "healthy" if llm_healthy else "degraded", "llm_service": { "status": "connected" if llm_healthy else "disconnected", "url": decomposer_service.llm_url }, "capabilities": [ "claim_decomposition", "entity_extraction", "complexity_analysis" ] } @app.post("/decompose", response_model=DecomposeResponse) async def decompose(request: DecomposeRequest): """Decompose claim into sub-claims""" result = await decomposer_service.decompose_claim( claim=request.claim, language=request.language, max_sub_claims=request.max_sub_claims ) if not result.success: raise HTTPException(status_code=500, detail=result.error) return result @app.post("/test") async def test_decomposer(): """Test decomposer with sample claim""" test_claim = "Việt Nam có 63 tỉnh thành và là nước nông nghiệp phát triển với dân số hơn 100 triệu người" result = await decomposer_service.decompose_claim(test_claim) return { "test_passed": result.success, "original_claim": result.original_claim, "sub_claims_count": len(result.sub_claims), "entities": result.entities, "complexity_score": result.complexity_score, "processing_time": result.processing_time, "sub_claims": [ { "text": sub.text, "confidence": sub.confidence, "entities": sub.entities } for sub in result.sub_claims ] } @app.post("/vietnamese-test") async def vietnamese_test(): """Test with Vietnamese political claim""" test_claim = "Chủ tịch Hồ Chí Minh đã tuyên bố độc lập Việt Nam vào ngày 2 tháng 9 năm 1945 tại Hà Nội" result = await decomposer_service.decompose_claim(test_claim) return { "test_passed": result.success, "claim": result.original_claim, "sub_claims": result.sub_claims, "entities": result.entities, "processing_time": result.processing_time } if __name__ == "__main__": print("Starting Decomposer Service...") print("Service will be available at: http://localhost:8006") print("LLM Service: http://localhost:8009") print("Function: Claim decomposition and entity extraction") uvicorn.run(app, host="0.0.0.0", port=8006) 